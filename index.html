<!-- =======================================================================
     index.html — BookerPilot (Full Rebuild)
     =======================================================================
     WHAT'S INSIDE
     - Tailwind + AOS + Feather
     - Marketing sections (Hero, Features, Demo, Pricing, FAQ, Contact)
     - Floating chat widget w/ Customer/Owner mode, quick-ask buttons
     - Supabase client wired to Edge Function 'ai-chat'
     - Smart local fallback (works without Edge if needed)
     - No "Acme" anywhere; defaults to your branding
     ======================================================================= -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>BookerPilot — AI Booking Widget for Local Services</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- AOS -->
  <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
  <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>

  <!-- Feather icons -->
  <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>

  <!-- Page styles -->
  <style>
    .gradient-bg { background: linear-gradient(135deg, #6B46C1 0%, #3182CE 100%); }
    .widget-bubble {
      position: fixed; bottom: 2rem; right: 2rem; width: 60px; height: 60px; border-radius: 50%;
      background: #4F46E5; color: #fff; display: flex; align-items: center; justify-content: center;
      cursor: pointer; box-shadow: 0 10px 25px -5px rgba(79,70,229,.4); z-index: 1000; transition: transform .2s ease;
    }
    .widget-bubble:hover { transform: scale(1.08); }
    .widget-panel {
      position: fixed; bottom: calc(2rem + 80px); right: 2rem; width: 420px; max-width: 95vw; height: 560px;
      background: #fff; border-radius: 16px; box-shadow: 0 20px 25px -5px rgba(0,0,0,.1), 0 10px 10px -5px rgba(0,0,0,.04);
      overflow: hidden; display: none; flex-direction: column; z-index: 1000;
    }
    @media (max-width: 640px) {
      .widget-bubble { bottom: 1rem; right: 1rem; }
      .widget-panel { bottom: calc(1rem + 80px); right: 1rem; }
    }
    /* little tag look for “NEW” etc */
    .tag {
      display: inline-block; font-size: 10px; line-height: 1; font-weight: 700; letter-spacing: .04em; text-transform: uppercase;
      background: rgba(79,70,229,.1); color: #4F46E5; padding: 4px 6px; border-radius: 6px;
    }
    /* code block */
    pre code { white-space: pre; }
  </style>
</head>
<body class="antialiased text-gray-900">

  <!-- ============================== NAV ============================== -->
  <nav class="bg-white/90 backdrop-blur-sm shadow-sm sticky top-0 z-40">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex items-center justify-between h-16">
        <div class="flex items-center">
          <i data-feather="calendar" class="h-6 w-6 text-indigo-600"></i>
          <span class="ml-2 text-lg sm:text-xl font-bold text-indigo-600">BookerPilot</span>
        </div>
        <div class="hidden md:flex items-center gap-8">
          <a href="#features" class="text-gray-600 hover:text-gray-900 text-sm font-medium">Features</a>
          <a href="#demo" class="text-gray-600 hover:text-gray-900 text-sm font-medium">Demo</a>
          <a href="#pricing" class="text-gray-600 hover:text-gray-900 text-sm font-medium">Pricing</a>
          <a href="#faq" class="text-gray-600 hover:text-gray-900 text-sm font-medium">FAQ</a>
          <a href="/login.html" class="text-indigo-600 text-sm font-semibold">Log in</a>
          <a href="/signup.html" class="bg-indigo-600 text-white px-4 py-2 rounded-full text-sm font-semibold hover:bg-indigo-700">Get Started</a>
        </div>
      </div>
    </div>
  </nav>

  <!-- ============================== HERO ============================== -->
  <header class="gradient-bg text-white">
    <div class="max-w-7xl mx-auto py-16 sm:py-24 px-4 sm:px-6 lg:px-8">
      <div class="text-center">
        <h1 class="text-4xl sm:text-6xl font-extrabold tracking-tight" data-aos="fade-up">
          Turn visitors into bookings — automatically
        </h1>
        <p class="mt-6 mx-auto max-w-3xl text-lg sm:text-xl text-indigo-100" data-aos="fade-up" data-aos-delay="80">
          Install one script. BookerPilot answers FAQs 24/7, takes deposits, syncs availability, and books jobs for you.
        </p>
        <div class="mt-8 flex justify-center gap-3" data-aos="fade-up" data-aos-delay="140">
          <a class="bg-white text-indigo-700 hover:bg-gray-50 font-semibold px-6 py-3 rounded-md" href="/signup.html">
            Start free trial
          </a>
          <a class="bg-indigo-700 hover:bg-indigo-800 text-white font-semibold px-6 py-3 rounded-md" href="#demo">
            See live demo
          </a>
        </div>
        <div class="mt-6">
          <span class="tag">No coding required</span>
          <span class="ml-2 tag">Stripe + Google Calendar</span>
          <span class="ml-2 tag">SMS reminders</span>
        </div>
      </div>
    </div>
  </header>

  <!-- ============================== LOGO CLOUD ============================== -->
  <section class="bg-gray-50">
    <div class="max-w-7xl mx-auto py-10 sm:py-14 px-4 sm:px-6 lg:px-8">
      <p class="text-center text-sm font-semibold uppercase text-gray-500 tracking-wide">
        Trusted by local businesses worldwide
      </p>
      <p class="mt-4 text-center text-gray-500">
        Nail salons • Hair salons • Cleaning • Tutors • Handymen • Mobile detailers • Pet groomers
      </p>
    </div>
  </section>

  <!-- ============================== FEATURES ============================== -->
  <section id="features" class="bg-white">
    <div class="max-w-7xl mx-auto py-12 sm:py-20 px-4 sm:px-6 lg:px-8">
      <div class="text-center">
        <h2 class="text-indigo-600 font-semibold tracking-wide uppercase" data-aos="fade-up">Features</h2>
        <p class="mt-2 text-3xl sm:text-4xl font-extrabold" data-aos="fade-up" data-aos-delay="60">
          Everything you need to grow your bookings
        </p>
      </div>

      <div class="mt-12 grid md:grid-cols-2 gap-8">
        <div class="flex" data-aos="fade-up">
          <div class="flex-shrink-0">
            <div class="h-12 w-12 rounded-md bg-indigo-500 text-white flex items-center justify-center">
              <i data-feather="message-square"></i>
            </div>
          </div>
          <div class="ml-4">
            <h3 class="text-lg font-semibold">AI chat that knows your business</h3>
            <p class="mt-2 text-gray-600">Answers pricing, services, policies — only from the data you upload. Converts questions into booked appointments.</p>
          </div>
        </div>

        <div class="flex" data-aos="fade-up" data-aos-delay="60">
          <div class="flex-shrink-0">
            <div class="h-12 w-12 rounded-md bg-indigo-500 text-white flex items-center justify-center">
              <i data-feather="clock"></i>
            </div>
          </div>
          <div class="ml-4">
            <h3 class="text-lg font-semibold">Live availability & no double-booking</h3>
            <p class="mt-2 text-gray-600">Connect Google Calendar or set custom hours. We check slots and prevent overlaps.</p>
          </div>
        </div>

        <div class="flex" data-aos="fade-up">
          <div class="flex-shrink-0">
            <div class="h-12 w-12 rounded-md bg-indigo-500 text-white flex items-center justify-center">
              <i data-feather="credit-card"></i>
            </div>
          </div>
          <div class="ml-4">
            <h3 class="text-lg font-semibold">Deposits via Stripe</h3>
            <p class="mt-2 text-gray-600">Collect a small deposit to reduce no-shows by 30–60%. Safe, PCI compliant. You control the amount.</p>
          </div>
        </div>

        <div class="flex" data-aos="fade-up" data-aos-delay="60">
          <div class="flex-shrink-0">
            <div class="h-12 w-12 rounded-md bg-indigo-500 text-white flex items-center justify-center">
              <i data-feather="smartphone"></i>
            </div>
          </div>
          <div class="ml-4">
            <h3 class="text-lg font-semibold">Auto confirmations & reminders</h3>
            <p class="mt-2 text-gray-600">Email + SMS keeps clients on schedule. Friendly reschedule links reduce cancellations.</p>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- ============================== DEMO ============================== -->
  <section id="demo" class="bg-gray-50">
    <div class="max-w-7xl mx-auto py-14 px-4 sm:px-6 lg:px-8">
      <div class="text-center">
        <h2 class="text-indigo-600 font-semibold tracking-wide uppercase" data-aos="fade-up">Live Demo</h2>
        <p class="mt-2 text-3xl sm:text-4xl font-extrabold" data-aos="fade-up" data-aos-delay="60">
          Try it now
        </p>
      </div>

      <div class="mt-10 grid lg:grid-cols-2 gap-8 items-start">
        <div class="bg-white border rounded-lg p-6 shadow-sm" data-aos="fade-right">
          <h3 class="text-xl font-bold text-gray-900">One-line install</h3>
          <p class="mt-2 text-gray-600">Paste these two lines anywhere on your site.</p>
          <div class="mt-4 bg-gray-900 rounded-lg p-4 overflow-x-auto">
            <pre class="text-gray-100 text-sm"><code>&lt;script src="https://cdn.booker.ai/widget.js" async&gt;&lt;/script&gt;
&lt;script&gt;
  window.BookerPilot = window.BookerPilot || function(){ (BookerPilot.q = BookerPilot.q || []).push(arguments); };
  BookerPilot("init", { business: "your-business-slug" });
&lt;/script&gt;</code></pre>
          </div>
          <div class="mt-6 flex items-center">
            <div class="h-10 w-10 rounded-full bg-indigo-100 text-indigo-600 flex items-center justify-center font-bold">1</div>
            <p class="ml-3 text-gray-700">Add your FAQs, services, pricing in the dashboard.</p>
          </div>
          <div class="mt-4 flex items-center">
            <div class="h-10 w-10 rounded-full bg-indigo-100 text-indigo-600 flex items-center justify-center font-bold">2</div>
            <p class="ml-3 text-gray-700">Connect Stripe & Google Calendar (optional).</p>
          </div>
          <div class="mt-4 flex items-center">
            <div class="h-10 w-10 rounded-full bg-indigo-100 text-indigo-600 flex items-center justify-center font-bold">3</div>
            <p class="ml-3 text-gray-700">Watch chats turn into booked appointments.</p>
          </div>
          <button id="open-demo-widget" class="mt-6 w-full bg-indigo-600 text-white font-semibold py-3 rounded-md hover:bg-indigo-700">
            Open Demo Widget
          </button>
        </div>

        <div class="bg-white border rounded-lg p-6 shadow-sm" data-aos="fade-left">
          <h3 class="text-xl font-bold">What to ask</h3>
          <p class="text-gray-600">Try any of these:</p>
          <ul class="mt-4 space-y-3 text-gray-700">
            <li class="flex"><i data-feather="chevron-right" class="mr-2 text-indigo-600"></i>“How can you help my nail business?”</li>
            <li class="flex"><i data-feather="chevron-right" class="mr-2 text-indigo-600"></i>“Can I take deposits to reduce no-shows?”</li>
            <li class="flex"><i data-feather="chevron-right" class="mr-2 text-indigo-600"></i>“What’s your cancellation policy?”</li>
            <li class="flex"><i data-feather="chevron-right" class="mr-2 text-indigo-600"></i>“Do you sync with Google Calendar?”</li>
            <li class="flex"><i data-feather="chevron-right" class="mr-2 text-indigo-600"></i>“How do I add pricing for gel manicures?”</li>
            <li class="flex"><i data-feather="chevron-right" class="mr-2 text-indigo-600"></i>“Book me for Friday 2pm.”</li>
          </ul>
        </div>
      </div>
    </div>
  </section>

  <!-- ============================== PRICING ============================== -->
  <section id="pricing" class="bg-white">
    <div class="max-w-7xl mx-auto py-14 px-4 sm:px-6 lg:px-8">
      <div class="text-center">
        <h2 class="text-indigo-600 font-semibold tracking-wide uppercase" data-aos="fade-up">Pricing</h2>
        <p class="mt-2 text-3xl sm:text-4xl font-extrabold" data-aos="fade-up" data-aos-delay="60">Simple plans</p>
      </div>

      <div class="mt-10 grid md:grid-cols-2 gap-6 lg:max-w-4xl lg:mx-auto">
        <div class="border rounded-lg shadow-sm" data-aos="fade-up">
          <div class="p-6">
            <h3 class="text-lg font-semibold">Starter</h3>
            <p class="mt-3"><span class="text-4xl font-extrabold">$49</span><span class="text-gray-500">/mo</span></p>
            <p class="mt-2 text-gray-500">Perfect for solo owners</p>
            <a href="https://buy.stripe.com/fZu8wO3Gd3NVc8s8EX43S03" target="_blank" rel="noopener" class="mt-6 block w-full bg-gray-900 text-white py-2 rounded-md text-center hover:bg-black">Start free trial</a>
          </div>
          <div class="px-6 pb-8">
            <h4 class="text-xs uppercase font-semibold text-gray-700">What’s included</h4>
            <ul class="mt-4 space-y-3 text-sm text-gray-600">
              <li class="flex"><i data-feather="check" class="text-green-500 mr-2"></i>50 conversations / month</li>
              <li class="flex"><i data-feather="check" class="text-green-500 mr-2"></i>15 bookings / month</li>
              <li class="flex"><i data-feather="check" class="text-green-500 mr-2"></i>Email confirmations</li>
              <li class="flex"><i data-feather="check" class="text-green-500 mr-2"></i>Basic analytics</li>
            </ul>
          </div>
        </div>

        <div class="border border-indigo-500 rounded-lg shadow-sm" data-aos="fade-up" data-aos-delay="60">
          <div class="p-6">
            <div class="flex items-start justify-between">
              <div>
                <h3 class="text-lg font-semibold">Pro</h3>
                <p class="text-indigo-600 text-sm mt-1">Most popular</p>
              </div>
            </div>
            <p class="mt-3"><span class="text-4xl font-extrabold">$99</span><span class="text-gray-500">/mo</span></p>
            <p class="mt-2 text-gray-500">For growing teams</p>
            <a href="https://buy.stripe.com/6oU3cu4Khacj6O81cv43S04" target="_blank" rel="noopener" class="mt-6 block w-full bg-indigo-600 text-white py-2 rounded-md text-center hover:bg-indigo-700">Start free trial</a>
          </div>
          <div class="px-6 pb-8">
            <h4 class="text-xs uppercase font-semibold text-gray-700">What’s included</h4>
            <ul class="mt-4 space-y-3 text-sm text-gray-600">
              <li class="flex"><i data-feather="check" class="text-green-500 mr-2"></i>Unlimited conversations</li>
              <li class="flex"><i data-feather="check" class="text-green-500 mr-2"></i>100 bookings / month</li>
              <li class="flex"><i data-feather="check" class="text-green-500 mr-2"></i>Email + SMS reminders</li>
              <li class="flex"><i data-feather="check" class="text-green-500 mr-2"></i>Advanced analytics</li>
              <li class="flex"><i data-feather="check" class="text-green-500 mr-2"></i>Membership upsells</li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- ============================== FAQ ============================== -->
  <section id="faq" class="bg-gray-50">
    <div class="max-w-7xl mx-auto py-14 px-4 sm:px-6 lg:px-8">
      <div class="text-center">
        <h2 class="text-indigo-600 font-semibold tracking-wide uppercase" data-aos="fade-up">FAQ</h2>
        <p class="mt-2 text-3xl sm:text-4xl font-extrabold" data-aos="fade-up" data-aos-delay="60">Frequently asked questions</p>
      </div>

      <div class="mt-10 grid md:grid-cols-2 gap-6">
        <div class="bg-white p-6 rounded-lg shadow-sm" data-aos="fade-up">
          <h3 class="text-lg font-semibold">Who is this for?</h3>
          <p class="mt-2 text-gray-600">Any local service business that takes appointments: nail salons, spas, salons, cleaners, tutors, handymen, trainers, pet groomers, more.</p>
        </div>
        <div class="bg-white p-6 rounded-lg shadow-sm" data-aos="fade-up" data-aos-delay="60">
          <h3 class="text-lg font-semibold">How does the AI work?</h3>
          <p class="mt-2 text-gray-600">It answers from your content only — your FAQs, services, pricing, policies — and guides visitors to book.</p>
        </div>
        <div class="bg-white p-6 rounded-lg shadow-sm" data-aos="fade-up">
          <h3 class="text-lg font-semibold">Payments?</h3>
          <p class="mt-2 text-gray-600">Stripe handles deposits securely. You control the amount or %.</p>
        </div>
        <div class="bg-white p-6 rounded-lg shadow-sm" data-aos="fade-up" data-aos-delay="60">
          <h3 class="text-lg font-semibold">Can I cancel?</h3>
          <p class="mt-2 text-gray-600">Anytime. No contracts.</p>
        </div>
      </div>
    </div>
  </section>

  <!-- ============================== CONTACT ============================== -->
  <section id="contact" class="bg-gray-50">
    <div class="max-w-7xl mx-auto py-14 px-4 sm:px-6 lg:px-8">
      <div class="text-center">
        <h2 class="text-indigo-600 font-semibold tracking-wide uppercase">Contact</h2>
        <p class="mt-2 text-3xl sm:text-4xl font-extrabold">Questions? We’re here to help.</p>
        <p class="mt-3 text-gray-600 max-w-2xl mx-auto">Fill out the form below and we’ll get back to you shortly.</p>
      </div>

      <form action="https://formsubmit.co/bookerpilot@outlook.com" method="POST" class="max-w-2xl mx-auto mt-8 space-y-3">
        <input type="hidden" name="_next" value="https://bookerpilot.com/index.html#contact">
        <input type="hidden" name="_subject" value="New Contact from BookerPilot Website">
        <input type="hidden" name="_captcha" value="false">
        <input type="text" name="name" placeholder="Your Name" class="w-full border rounded-lg px-3 py-2" required>
        <input type="email" name="email" placeholder="Your Email" class="w-full border rounded-lg px-3 py-2" required>
        <textarea name="message" placeholder="Your Question or Message" class="w-full border rounded-lg px-3 py-2 h-32" required></textarea>
        <button type="submit" class="w-full bg-indigo-600 text-white py-3 rounded-lg hover:bg-indigo-700 shadow">Send Message</button>
      </form>
    </div>
  </section>

  <!-- ============================== CTA ============================== -->
  <section class="gradient-bg">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12 lg:py-16 flex flex-col lg:flex-row items-center justify-between">
      <h2 class="text-3xl sm:text-4xl font-extrabold text-white" data-aos="fade-right">
        <span class="block">Ready to get started?</span>
        <span class="block text-indigo-200">Start your free trial today.</span>
      </h2>
      <div class="mt-6 lg:mt-0 flex gap-3" data-aos="fade-left">
        <a href="/signup.html" class="px-5 py-3 rounded-md bg-white text-indigo-700 font-semibold hover:bg-indigo-50">Get started</a>
        <a href="#demo" class="px-5 py-3 rounded-md bg-indigo-500 bg-opacity-70 text-white font-semibold hover:bg-opacity-80">Live demo</a>
      </div>
    </div>
  </section>

  <!-- ============================== FOOTER ============================== -->
  <footer class="bg-white">
    <div class="max-w-7xl mx-auto py-10 px-4 sm:px-6 lg:px-8">
      <nav class="-mx-5 -my-2 flex flex-wrap justify-center">
        <a href="#" class="px-5 py-2 text-gray-600 hover:text-gray-900">Home</a>
        <a href="#features" class="px-5 py-2 text-gray-600 hover:text-gray-900">Features</a>
        <a href="#pricing" class="px-5 py-2 text-gray-600 hover:text-gray-900">Pricing</a>
        <a href="#faq" class="px-5 py-2 text-gray-600 hover:text-gray-900">FAQ</a>
        <a href="#" class="px-5 py-2 text-gray-600 hover:text-gray-900">Privacy</a>
        <a href="#" class="px-5 py-2 text-gray-600 hover:text-gray-900">Terms</a>
      </nav>
      <p class="mt-6 text-center text-gray-400">© <span id="year"></span> BookerPilot. All rights reserved.</p>
    </div>
  </footer>

  <!-- ============================== WIDGET BUBBLE ============================== -->
  <div id="widget-bubble" class="widget-bubble" aria-label="Open chat">
    <i data-feather="message-square"></i>
  </div>

  <!-- ============================== WIDGET PANEL ============================== -->
  <div id="widget-panel" class="widget-panel" role="dialog" aria-modal="true" aria-label="BookerPilot Chat">
    <!-- Header -->
    <div class="bg-indigo-600 text-white p-4">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-2">
          <i data-feather="zap" class="w-5 h-5"></i>
          <h3 id="widget-title" class="font-semibold">Your Business</h3>
        </div>
        <div class="flex items-center gap-2">
          <span class="text-indigo-200 text-xs">Mode:</span>
          <div class="bg-indigo-500/40 rounded-md overflow-hidden flex text-sm">
            <button id="mode-customer" class="px-3 py-1 bg-white text-indigo-700">Customer</button>
            <button id="mode-owner" class="px-3 py-1 text-white hover:bg-indigo-500">Owner</button>
          </div>
          <button id="close-widget" class="ml-2 text-white hover:text-indigo-200" aria-label="Close">
            <i data-feather="x"></i>
          </button>
        </div>
      </div>
    </div>

    <!-- Stream + Suggestions -->
    <div class="flex-1 p-4 overflow-y-auto">
      <div id="chat-stream" class="space-y-4"></div>

      <div id="suggestions" class="mt-4"></div>
    </div>

    <!-- Input -->
    <div class="border-t border-gray-200 p-4">
      <div class="flex items-center">
        <input id="chat-input" type="text" placeholder="Type your question…" class="flex-1 border border-gray-300 rounded-l-md py-2 px-3 focus:outline-none focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500">
        <button id="send-btn" class="bg-indigo-600 text-white px-4 py-2 rounded-r-md hover:bg-indigo-700">
          <i data-feather="send"></i>
        </button>
      </div>
    </div>
  </div>

  <!-- ============================== LIBS ============================== -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

  <!-- ============================== APP SCRIPT ============================== -->
  <script>
  (function(){
    'use strict';

    // ------------------ AOS + Feather ------------------
    AOS.init({ duration: 800, easing: 'ease-in-out', once: true });
    try { feather.replace(); } catch {}

    // ------------------ Footer year --------------------
    document.getElementById('year').textContent = new Date().getFullYear();

    // ------------------ CONFIG (EDIT) ------------------
    const CONFIG = {
      businessName: 'Your Business',              // shows in widget title & replies
      shortDesc: 'We turn visitors into bookings with AI.',
      contactEmail: 'bookerpilot@outlook.com',
      hours: 'Mon–Sat, 8:00am–6:00pm',
      areas: ['Brooklyn','Queens','Manhattan','Bronx','Staten Island'],

      pricing: { studio: 99, '1br': 129, '2br': 159, deepCleanAddOn: 60 },  // example fields
      cancellation: 'Free cancellation up to 24 hours before your appointment.',
      payments: 'Deposits via Stripe. You control the amount or %.',
      supplies: 'We bring our own supplies (where applicable).',
      firstTime: 'First-time service may take longer. We confirm estimates before booking.',

      // Edge Function config
      supabaseUrl: 'https://lzitxdifsukaywuansgh.supabase.co',
      supabaseAnonKey: 'YOUR-ANON-PUBLIC-KEY',

      // Chat behavior
      typingSpeedMs: 14,
      maxMessagesPerHour: 20,
      audienceDefault: 'customer',
      quickCustomerQs: [
        'How can you help my nail business?',
        'What services do you offer?',
        'Do you take deposits to reduce no-shows?',
        'Do you sync with Google Calendar?',
        'How do I reschedule?',
        'What’s your cancellation policy?',
        'Can I book for tomorrow at 10am?',
        'Do you serve my area?'
      ],
      quickOwnerQs: [
        'Explain exactly how you increase bookings.',
        'How do deposits reduce no-shows?',
        'How do I add pricing for gel manicures?',
        'How do I connect Stripe and set a deposit %?',
        'Can you handle add-ons and upsells?',
        'What analytics are included?',
        'How do I embed the widget on my site?',
        'How do I import my FAQs?'
      ]
    };

    // ------------------ DOM HOOKS ----------------------
    const $ = (s, r=document) => r.querySelector(s);
    const bubble     = $('#widget-bubble');
    const panel      = $('#widget-panel');
    const closeBtn   = $('#close-widget');
    const openDemo   = $('#open-demo-widget');

    const chatStream = $('#chat-stream');
    const suggestions= $('#suggestions');
    const input      = $('#chat-input');
    const sendBtn    = $('#send-btn');
    const titleEl    = $('#widget-title');

    const modeCustomerBtn = $('#mode-customer');
    const modeOwnerBtn    = $('#mode-owner');

    // Set widget title
    if (titleEl) titleEl.textContent = CONFIG.businessName;

    // ------------------ STATE --------------------------
    const sb = window.supabase?.createClient(CONFIG.supabaseUrl, CONFIG.supabaseAnonKey);
    const SESSION = {
      id: crypto.randomUUID(),
      turns: [],
      asksInWindow: 0,
      lastReset: Date.now()
    };
    const STATE = {
      audience: CONFIG.audienceDefault // 'customer' | 'owner'
    };

    // ------------------ UI HELPERS ---------------------
    function scrollToBottom(){
      const box = panel?.querySelector('.flex-1.p-4.overflow-y-auto');
      if (!box) return;
      box.scrollTop = box.scrollHeight;
    }
    function stripHtml(s){ return String(s||'').replace(/[\u0000-\u001F<>]/g,''); }
    function norm(s){ return stripHtml(String(s||'').toLowerCase().trim()); }
    function bubbleEl(text, who='bot'){
      const wrap = document.createElement('div');
      wrap.className = `flex ${who==='user'?'justify-end':'justify-start'}`;
      const bub = document.createElement('div');
      bub.className = `max-w-xs lg:max-w-md px-4 py-2 rounded-lg ${
        who==='user' ? 'rounded-tr-none bg-indigo-600 text-white' : 'rounded-tl-none bg-gray-100 text-gray-800'
      }`;
      bub.textContent = text;
      wrap.appendChild(bub);
      chatStream?.appendChild(wrap);
      scrollToBottom();
      return bub;
    }
    function typeInto(el, fullText, speed=CONFIG.typingSpeedMs){
      el.textContent = '';
      let i = 0; fullText = String(fullText);
      return new Promise(resolve=>{
        (function tick(){
          if (i >= fullText.length) return resolve();
          el.textContent += fullText[i++];
          scrollToBottom();
          setTimeout(tick, speed);
        })();
      });
    }
    function ctaRow(){
      const row = document.createElement('div');
      row.className = 'flex gap-2 pt-2';
      const a = document.createElement('a');
      a.href='/signup.html'; a.textContent='Start free trial';
      a.className='px-3 py-1 text-sm bg-indigo-600 text-white rounded hover:bg-indigo-700';
      const b = document.createElement('a');
      b.href='#pricing'; b.textContent='See pricing';
      b.className='px-3 py-1 text-sm border rounded hover:bg-gray-50';
      row.appendChild(a); row.appendChild(b);
      return row;
    }

    // ------------------ OPEN/CLOSE ---------------------
    function openWidget(){ panel.style.display='flex'; bubble.style.display='none'; setTimeout(()=>input?.focus(), 60); }
    function closeWidget(){ panel.style.display='none'; bubble.style.display='flex'; }
    bubble?.addEventListener('click', openWidget);
    openDemo?.addEventListener('click', openWidget);
    closeBtn?.addEventListener('click', closeWidget);
    window.addEventListener('keydown', e=>{ if(e.key==='Escape') closeWidget(); });

    // ------------------ MODE + SUGGESTIONS -------------
    function renderSuggestions(){
      if (!suggestions) return;
      suggestions.innerHTML = '';
      const title = document.createElement('div');
      title.className = 'text-xs text-gray-500 mb-2';
      title.textContent = STATE.audience === 'owner' ? 'Owner questions to try:' : 'Customer questions to try:';
      suggestions.appendChild(title);

      const list = STATE.audience === 'owner' ? CONFIG.quickOwnerQs : CONFIG.quickCustomerQs;
      const grid = document.createElement('div'); grid.className = 'flex flex-wrap gap-2';
      list.forEach(q => {
        const btn = document.createElement('button');
        btn.className = 'text-sm px-3 py-1 border rounded hover:bg-gray-50';
        btn.textContent = q;
        btn.addEventListener('click', ()=>{ input.value = q; send(); });
        grid.appendChild(btn);
      });
      suggestions.appendChild(grid);
    }
    function setAudience(a){
      STATE.audience = a;
      if (a === 'owner') {
        modeOwnerBtn.className    = 'px-3 py-1 bg-white text-indigo-700';
        modeCustomerBtn.className = 'px-3 py-1 text-white hover:bg-indigo-500';
      } else {
        modeCustomerBtn.className = 'px-3 py-1 bg-white text-indigo-700';
        modeOwnerBtn.className    = 'px-3 py-1 text-white hover:bg-indigo-500';
      }
      renderSuggestions();
    }
    modeCustomerBtn?.addEventListener('click', ()=> setAudience('customer'));
    modeOwnerBtn?.addEventListener('click', ()=> setAudience('owner'));

    // ------------------ RATE LIMIT ---------------------
    function checkRateLimit(){
      const now = Date.now();
      if (now - SESSION.lastReset > 3600_000){ SESSION.asksInWindow = 0; SESSION.lastReset = now; }
      if (SESSION.asksInWindow >= CONFIG.maxMessagesPerHour) {
        return `Demo limit reached (${CONFIG.maxMessagesPerHour}/hr). Please try again later.`;
      }
      SESSION.asksInWindow++;
      return null;
    }

    // ------------------ BUSINESS TYPE GUESS ------------
    function guessBusinessType(s){
      const t = norm(s);
      if (/(nail|manicure|pedicure|gel|acrylic|shellac|dip powder)/.test(t)) return 'nail_salon';
      if (/(hair|salon|barber|stylist|color|cut|blowout)/.test(t)) return 'hair_salon';
      if (/(clean|maid|housekeeping|apartment)/.test(t)) return 'cleaning';
      if (/(tutor|lesson|class)/.test(t)) return 'tutoring';
      if (/(pet|groom|dog|cat)/.test(t)) return 'pet_grooming';
      if (/(handyman|repair|plumb|electric)/.test(t)) return 'handyman';
      return 'local_services';
    }

    // ------------------ LOCAL FALLBACK BRAIN -----------
    // This generates a *useful* answer even if the Edge Function is down.
    function localAnswer(userText){
      const t = norm(userText);
      // Nail-business specific "how can you help my nail business"
      if (/(how.+help.+(my )?nail(s)?|nail business|nail salon)/.test(t)) {
        return [
          'Here’s how we help a nail salon, step-by-step:',
          '1) Capture more bookings: We answer FAQs (prices, gel vs acrylic, availability) and move clients straight into booking.',
          '2) Cut no-shows: Take a small Stripe deposit (you choose %). Auto reminders via email/SMS.',
          '3) Fill slow times: Suggest nearby times if a slot is taken, and promote add-ons (gel removal, nail art).',
          '4) Fewer phone interruptions: Common questions get answered instantly so your techs can focus on clients.',
          '5) Easy setup: Paste one script, add your services/prices/policies. Optional Google Calendar sync.',
          '',
          'Want an example prompt? Try: “Add a gel manicure with nail art for Friday 2pm.”'
        ].join('\n');
      }
      // Common topics
      if (/(price|how much|cost|rate|fee)/.test(t)) {
        return 'We’ll present your service list with clear prices and upsells. If you use deposits, we show the deposit due now and the balance due at the visit.';
      }
      if (/(availability|available|slot|time|when|schedule)/.test(t)) {
        return `We read your hours (${CONFIG.hours}) and can sync Google Calendar to avoid overlaps. We’ll show the next best slot if a time is busy.`;
      }
      if (/(cancel|cancellation|reschedule|refund)/.test(t)) {
        return CONFIG.cancellation;
      }
      if (/(deposit|stripe|card|visa|amex|mastercard|payment)/.test(t)) {
        return CONFIG.payments;
      }
      if (/(area|serve|location|where|city|borough)/.test(t)) {
        return `We serve: ${CONFIG.areas.join(', ')}.`;
      }
      if (/(hours|open|close)/.test(t)) {
        return `Our hours are ${CONFIG.hours}.`;
      }
      // Booking phrases with minimal extraction
      const day = t.match(/\b(today|tomorrow|mon(day)?|tue(s(day)?)?|wed(nesday)?|thu(rsday)?|fri(day)?|sat(urday)?|sun(day)?)\b/);
      const time = t.match(/\b(\d{1,2}(:\d{2})?\s?(am|pm))\b/);
      if (/(book|schedule|appointment|reserve)/.test(t) && (day || time)) {
        return `Great — I can pencil you in for ${day ? day[0] : 'the next available day'} at ${time ? time[0] : 'a convenient time'} (demo confirmation only, no charges).`;
      }
      // Owner mode hints
      if (STATE.audience === 'owner') {
        if (/connect|install|embed/.test(t)) {
          return 'Embedding is simple: paste the 2-line snippet on your site. Connect Stripe and Google Calendar in the dashboard. Add services, prices, and FAQs to train the assistant.';
        }
        if (/analytics|report|dashboard/.test(t)) {
          return 'Analytics include conversation volume, conversion to booking, drop-off points, and top questions. Use this to tune pricing, hours, and promos.';
        }
      }
      // Default helpful message
      return `I can help with pricing, availability, deposits, policies, and booking. Ask something like “How do deposits reduce no-shows?” or “Add gel manicure Friday 2pm.”`;
    }

    // ------------------ EDGE FUNCTION CALL -------------
    async function callEdge(userText){
      if (!sb) throw new Error('Supabase not available.');
      const payload = {
        message: {
          text: userText,
          audience: STATE.audience,
          businessType: guessBusinessType(userText)
        },
        brand: {
          name: CONFIG.businessName,
          shortDesc: CONFIG.shortDesc,
          contactEmail: CONFIG.contactEmail,
          hours: CONFIG.hours,
          areas: CONFIG.areas,
          pricing: CONFIG.pricing,
          payments: CONFIG.payments,
          cancellation: CONFIG.cancellation
        },
        history: SESSION.turns.slice(-8), // pass last 8 turns
        meta: {
          page: location.pathname,
          ref: document.referrer?.slice(0, 180) || ''
        }
      };

      const { data, error } = await sb.functions.invoke('ai-chat', { body: payload });
      if (error) throw error;
      if (!data?.text) throw new Error('No text returned from ai-chat');
      // Final sanitation: ensure no "Acme Cleaning" ever leaks
      return String(data.text).replace(/\bacme\s+cleaning\b/gi, CONFIG.businessName);
    }

    // ------------------ SEND FLOW ----------------------
    async function send(){
      const text = (input?.value || '').trim();
      if (!text) return;

      // rate limit
      const limit = checkRateLimit();

      // user bubble
      bubbleEl(text, 'user');
      SESSION.turns.push({ role: 'user', content: stripHtml(text) });
      input.value = '';

      // bot typing bubble
      const thinking = bubbleEl('Thinking…', 'bot');

      try {
        if (limit) {
          await typeInto(thinking, limit);
          return;
        }
        // Call Edge; on failure use localAnswer
        let reply = await callEdge(text);
        // Ensure it's specific when user asks “how can you help my nail business”
        if (/(how.+help.+(my )?nail(s)?|nail business|nail salon)/i.test(text)) {
          // If model returned something generic, reinforce specifics:
          if (!/deposit|calendar|upsell|reminder|faq|policy|no-?show/i.test(reply)) {
            reply = localAnswer(text); // a strong, specific local answer
          }
        }

        // Append contact line only if not already present
        if (!/bookerpilot@outlook\.com/i.test(reply)) {
          reply += `\n\nQuestions? Email ${CONFIG.contactEmail}.`;
        }

        await typeInto(thinking, reply);
        thinking.parentElement.appendChild(ctaRow());
        SESSION.turns.push({ role: 'assistant', content: reply });

      } catch (e) {
        // Local fallback
        const fallback = `${localAnswer(text)}\n\nQuestions? Email ${CONFIG.contactEmail}.`;
        thinking.textContent = fallback;
        thinking.parentElement.appendChild(ctaRow());
        SESSION.turns.push({ role: 'assistant', content: fallback });
        console.error('Edge error:', e);
      }
    }

    sendBtn?.addEventListener('click', send);
    input?.addEventListener('keydown', e=>{ if (e.key === 'Enter'){ e.preventDefault(); send(); }});

    // ------------------ GREETING -----------------------
    let greeted = false;
    function greet(){
      if (greeted) return; greeted = true;
      const g = bubbleEl('', 'bot');
      const benefit = 'Book more jobs automatically, cut no-shows with deposits, and answer FAQs 24/7.';
      typeInto(g, `Hi! I’m the ${CONFIG.businessName} assistant. ${benefit}\n\nAsk me anything, or tap a suggestion below.`)
        .then(()=>{
          g.parentElement.appendChild(ctaRow());
          setAudience(CONFIG.audienceDefault);
        });
    }
    bubble?.addEventListener('click', greet);
    openDemo?.addEventListener('click', greet);

  })();
  </script>

</body>
</html>
