<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>BookerPilot — Anything that needs booking needs a pilot.</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #0b1b2b;        /* Navy */
      --sky: #e6f1ff;       /* Sky */
      --card: #ffffff;
      --ink: #0b1b2b;
      --muted: #5b6b7c;
      --primary: #2563eb;   /* Blue */
      --ring: rgba(37,99,235,.2);
      --radius: 14px;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto;
      color: var(--ink); background: linear-gradient(180deg, var(--sky), #fff 40%);
    }
    header {
      background: var(--bg); color: #fff; padding: 28px 18px; text-align: center;
    }
    header h1 { margin: 0 0 6px 0; font-size: 28px; }
    header p { margin: 0; opacity: .85; }
    main { max-width: 1100px; margin: 24px auto; padding: 0 16px; }
    .grid { display: grid; gap: 16px; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); }
    .card {
      background: var(--card); border: 1px solid #e5e7eb; border-radius: var(--radius);
      box-shadow: 0 10px 30px rgba(0,0,0,.06); padding: 16px;
    }
    .card h2 { margin: 0 0 10px 0; font-size: 18px; }
    label { display: block; font-size: 14px; color: var(--muted); margin: 12px 0 6px; }
    input, select, textarea {
      width: 100%; padding: 10px 12px; border: 1px solid #e5e7eb; border-radius: 10px; outline: none;
    }
    input:focus, select:focus, textarea:focus { border-color: var(--primary); box-shadow: 0 0 0 4px var(--ring); }
    button {
      background: var(--primary); color: #fff; padding: 10px 14px; border: none; border-radius: 10px;
      cursor: pointer;
    }
    button:disabled { opacity: .5; cursor: not-allowed; }
    table { width: 100%; border-collapse: collapse; font-size: 14px; }
    th, td { padding: 8px 6px; border-bottom: 1px solid #eee; text-align: left; }
    .muted { color: var(--muted); }
    .pill { display:inline-block; padding:2px 8px; border-radius:999px; background:#eef2ff; color:#4338ca; font-size:12px; }
    .row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .right { text-align:right; }
    .mt8{margin-top:8px} .mt12{margin-top:12px} .mt16{margin-top:16px} .mt20{margin-top:20px}
    .mb0{margin-bottom:0}
    /* Floating launcher */
    #bp-float { position: fixed; bottom: 20px; right: 20px; z-index: 9999; width: 380px; max-width: 92vw; }
    #bp-toggle {
      position: absolute; bottom: 0; right: 0; transform: translateY(100%); background:#fff; color:#111;
      border:1px solid #e5e7eb; border-radius:999px; padding:10px 14px; box-shadow:0 10px 24px rgba(0,0,0,.15);
    }
    #bp-panel { display:none; background:#fff; border:1px solid #e5e7eb; border-radius:16px; box-shadow:0 16px 42px rgba(0,0,0,.2); overflow:hidden; }
    #bp-panel header { background:#fff; color:#111; padding:10px 12px; border-bottom:1px solid #eee; }
    #bp-content { max-height: 70vh; overflow:auto; padding: 10px; }
    canvas { width: 100%; height: 160px; display:block; }
  </style>
</head>
<body>
  <header>
    <h1>Anything that needs booking needs a pilot.</h1>
    <p class="muted">Answers fast. Payments simple. Bookings on autopilot.</p>
  </header>

  <main>
    <div class="grid">
      <!-- AI Q&A -->
      <section class="card" id="qa">
        <h2 class="mb0">Ask a question</h2>
        <p class="muted mt8">Ask about the business or anything general.</p>
        <div class="row mt12">
          <input id="q" placeholder="Try: Do you offer private sessions?" />
          <button id="ask">Ask</button>
        </div>
        <p id="a" class="mt12"></p>
      </section>

      <!-- Booking form -->
      <section class="card" id="book">
        <h2 class="mb0">Start a booking</h2>
        <p class="muted mt8">Choose service, pick a time, add notes.</p>
        <label>Service</label>
        <select id="svc"></select>
        <label>Start time</label>
        <input id="starts" type="datetime-local" />
        <label>Customer name</label>
        <input id="cust" placeholder="Full name" />
        <label>Notes (what was requested)</label>
        <textarea id="notes" rows="3" placeholder="Anything special to request?"></textarea>
        <button id="bookBtn" class="mt12">Book it</button>
        <p id="bookOut" class="mt12"></p>
      </section>

      <!-- Dashboard (dev) -->
      <section class="card" id="dash">
        <h2 class="mb0">Business Dashboard</h2>
        <p class="muted mt8">Overview, Orders, Payments &times; (dev mode)</p>
        <div id="guard" class="muted mt8">Append <code>?admin=1</code> to the URL to view.</div>
        <div id="dashContent" style="display:none;">
          <div class="grid">
            <div class="card">
              <h3 class="mb0">Overview</h3>
              <div id="kpis" class="mt12"></div>
              <canvas id="chart" class="mt12"></canvas>
            </div>
            <div class="card">
              <h3 class="mb0">Orders</h3>
              <div id="orders" class="mt12"></div>
            </div>
            <div class="card">
              <h3 class="mb0">Payments</h3>
              <div id="payments" class="mt12"></div>
            </div>
          </div>
        </div>
      </section>
    </div>
  </main>

  <!-- Floating widget (Ask + Quick Book) -->
  <div id="bp-float">
    <button id="bp-toggle">Open BookerPilot</button>
    <div id="bp-panel" role="dialog" aria-label="BookerPilot">
      <header class="row" style="justify-content:space-between">
        <strong>BookerPilot</strong>
        <button id="bp-close" style="background:transparent;border:none;font-size:18px;cursor:pointer">×</button>
      </header>
      <div id="bp-content"></div>
    </div>
  </div>

  <script>
    // Remove legacy placeholder text if present
    (function removeLegacy() {
      const BAD = ['AI will be enabled in the next step', 'I’ll check your question against your business info'];
      document.querySelectorAll('body *').forEach(el => {
        const t = (el.textContent||'').trim();
        if (!t) return;
        if (BAD.some(x => t.includes(x))) {
          let target = el;
          for (let i=0;i<4 && target && target.parentElement;i++){
            if (/^(SECTION|DIV|ARTICLE)$/i.test(target.tagName)) break;
            target = target.parentElement;
          }
          (target || el).remove();
        }
      });
    })();

    // Read config from URL
    const url = new URL(location.href);
    const BUSINESS_SLUG = url.searchParams.get('slug') || 'sunrise-yoga'; // change default if needed
    const IS_ADMIN = url.searchParams.get('admin') === '1';
    const API = 'http://localhost:3001';

    // Elements
    const $q = document.getElementById('q');
    const $ask = document.getElementById('ask');
    const $a = document.getElementById('a');
    const $svc = document.getElementById('svc');
    const $starts = document.getElementById('starts');
    const $cust = document.getElementById('cust');
    const $notes = document.getElementById('notes');
    const $bookBtn = document.getElementById('bookBtn');
    const $bookOut = document.getElementById('bookOut');

    // Floating widget
    (function widget() {
      const shell = document.getElementById('bp-float');
      const panel = document.getElementById('bp-panel');
      const toggle = document.getElementById('bp-toggle');
      const close = document.getElementById('bp-close');
      const content = document.getElementById('bp-content');

      // Build compact Ask + Quick Book
      const wrap = document.createElement('div');
      wrap.innerHTML = `
        <section class="card">
          <h2 class="mb0">Ask a question</h2>
          <div class="row mt12">
            <input id="wq" placeholder="Ask anything…" />
            <button id="wask">Ask</button>
          </div>
          <p id="wa" class="mt12"></p>
        </section>
        <section class="card mt12">
          <h2 class="mb0">Quick book</h2>
          <label class="mt12">Service</label>
          <select id="wsvc"></select>
          <label>Start</label>
          <input id="wstarts" type="datetime-local" />
          <label>Name</label>
          <input id="wcust" placeholder="Full name" />
          <button id="wbook" class="mt12">Book</button>
          <p id="wout" class="mt12"></p>
        </section>
      `;
      content.appendChild(wrap);

      toggle.addEventListener('click', ()=>{ panel.style.display='block'; toggle.style.display='none'; });
      close.addEventListener('click', ()=>{ panel.style.display='none'; toggle.style.display='inline-block'; });

      // Wire mini ask
      wrap.querySelector('#wask').addEventListener('click', async ()=>{
        const q = wrap.querySelector('#wq').value.trim();
        const out = wrap.querySelector('#wa');
        if (!q) { out.textContent = 'Type something first.'; return; }
        out.textContent = 'Thinking…';
        try {
          const r = await fetch(`${API}/api/ask`, {
            method:'POST', headers:{'Content-Type':'application/json'},
            body: JSON.stringify({ q, businessSlug: BUSINESS_SLUG })
          });
          const j = await r.json();
          out.textContent = j.answer || j.error || 'Error';
        } catch (e) { out.textContent = 'Network error'; }
      });

      // Load services into widget
      fetch(`${API}/api/services?slug=${encodeURIComponent(BUSINESS_SLUG)}`)
        .then(r=>r.json()).then(j=>{
          const wsvc = wrap.querySelector('#wsvc');
          (j.services||[]).forEach(s=>{
            const opt = document.createElement('option');
            opt.value = s.id;
            opt.textContent = `${s.name} — ${s.price_cents!=null?('$'+(s.price_cents/100).toFixed(2)):'—'}`;
            wsvc.appendChild(opt);
          });
        });

      // Wire quick book
      wrap.querySelector('#wbook').addEventListener('click', async ()=>{
        const wsvc = wrap.querySelector('#wsvc');
        const wstarts = wrap.querySelector('#wstarts');
        const wcust = wrap.querySelector('#wcust');
        const out = wrap.querySelector('#wout');
        if (!wsvc.value || !wstarts.value || !wcust.value.trim()) { out.textContent='Fill service, start, and name.'; return; }
        out.textContent = 'Booking…';
        try {
          const r = await fetch(`${API}/api/bookings`, {
            method:'POST', headers:{'Content-Type':'application/json'},
            body: JSON.stringify({
              businessSlug: BUSINESS_SLUG,
              serviceId: wsvc.value,
              starts_at: new Date(wstarts.value).toISOString(),
              customer_name: wcust.value.trim(),
              notes: null
            })
          });
          const j = await r.json();
          out.textContent = r.ok ? `Booked! id: ${j.id}` : (j.error || 'Error');
        } catch (e) { out.textContent = 'Network error'; }
      });
    })();

    // Main Ask
    async function ask() {
      const q = $q.value.trim();
      if (!q) { $a.textContent = 'Type a question first.'; return; }
      $a.textContent = 'Thinking…';
      try {
        const r = await fetch(`${API}/api/ask`, {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ q, businessSlug: BUSINESS_SLUG })
        });
        const j = await r.json();
        $a.textContent = r.ok ? (j.answer || '') : (j.error || 'Error');
      } catch (e) { $a.textContent = 'Network error'; }
    }
    document.getElementById('ask').addEventListener('click', ask);
    $q.addEventListener('keydown', e => { if (e.key === 'Enter') ask(); });

    // Load services into main form
    async function loadServices() {
      $svc.innerHTML = '';
      const r = await fetch(`${API}/api/services?slug=${encodeURIComponent(BUSINESS_SLUG)}`);
      const j = await r.json();
      (j.services||[]).forEach(s=>{
        const opt = document.createElement('option');
        opt.value = s.id;
        opt.textContent = `${s.name} — ${s.price_cents!=null?('$'+(s.price_cents/100).toFixed(2)):'—'}`;
        $svc.appendChild(opt);
      });
    }

    // Main booking
    async function book() {
      const serviceId = $svc.value;
      const startsVal = $starts.value;
      const customer_name = $cust.value.trim();
      const notes = $notes.value.trim() || null;
      if (!serviceId || !startsVal || !customer_name) {
        $bookOut.textContent = 'Please fill service, start time, and name.'; return;
      }
      $bookOut.textContent = 'Booking…';
      try {
        const r = await fetch(`${API}/api/bookings`, {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({
            businessSlug: BUSINESS_SLUG,
            serviceId,
            starts_at: new Date(startsVal).toISOString(),
            customer_name,
            notes
          })
        });
        const j = await r.json();
        $bookOut.textContent = r.ok ? `Booked! id: ${j.id}` : (j.error || 'Error');
      } catch (e) { $bookOut.textContent = 'Network error'; }
    }
    $bookBtn.addEventListener('click', book);

    // Dashboard (dev) — ?admin=1
    (function dashboard() {
      const guard = document.getElementById('guard');
      const dashContent = document.getElementById('dashContent');
      if (!IS_ADMIN) return;
      guard.style.display = 'none';
      dashContent.style.display = 'block';

      const $kpis = document.getElementById('kpis');
      const $orders = document.getElementById('orders');
      const $payments = document.getElementById('payments');

      function fmtUSD(cents){ return '$' + (cents/100).toFixed(2); }

      async function renderSummary() {
        const r = await fetch(`${API}/api/business/${encodeURIComponent(BUSINESS_SLUG)}/summary`);
        const j = await r.json();
        if (!r.ok) { $kpis.textContent = j.error || 'Error'; return; }
        const k = j.kpis || {};
        $kpis.innerHTML = `
          <div class="grid">
            <div class="card"><div class="muted">Today</div><div style="font-size:22px">${k.todayBookings||0} bookings</div></div>
            <div class="card"><div class="muted">7 days</div><div style="font-size:22px">${k.sevenDayBookings||0} bookings</div></div>
            <div class="card"><div class="muted">Revenue (booked)</div><div style="font-size:22px">${fmtUSD(k.revenueCentsBooked||0)}</div></div>
            <div class="card"><div class="muted">Revenue (paid)</div><div style="font-size:22px">${fmtUSD(k.revenueCentsPaid||0)}</div></div>
          </div>
        `;
        drawLine(document.getElementById('chart'), (j.series||[]).map(s=>({ x:s.date, y:s.revenue_cents||0 })));
      }

      async function renderOrders() {
        const r = await fetch(`${API}/api/business/${encodeURIComponent(BUSINESS_SLUG)}/orders?limit=50`);
        const j = await r.json();
        if (!r.ok) { $orders.textContent = j.error || 'Error'; return; }
        const rows = j.orders || [];
        if (!rows.length) { $orders.textContent = 'No orders yet.'; return; }
        $orders.innerHTML = `
          <table>
            <thead><tr><th>When</th><th>Customer</th><th>Service</th><th class="right">Total</th><th>Status</th><th>Payment</th></tr></thead>
            <tbody>
              ${rows.map(r=>`
                <tr>
                  <td>${new Date(r.starts_at).toLocaleString()}</td>
                  <td>${r.customer_name || '—'}</td>
                  <td>${r.service_name || '—'}</td>
                  <td class="right">${r.total_cents!=null?fmtUSD(r.total_cents):'—'}</td>
                  <td><span class="pill">${r.status}</span></td>
                  <td><span class="pill">${r.payment_status}</span></td>
                </tr>
                ${r.notes ? `<tr><td colspan="6" class="muted">Notes: ${r.notes}</td></tr>`:''}
              `).join('')}
            </tbody>
          </table>
        `;
      }

      async function renderPayments() {
        const r = await fetch(`${API}/api/business/${encodeURIComponent(BUSINESS_SLUG)}/payments?limit=50`);
        const j = await r.json();
        if (!r.ok) { $payments.textContent = j.error || 'Error'; return; }
        const rows = j.payments || [];
        if (!rows.length) { $payments.textContent = 'No payments yet.'; return; }
        $payments.innerHTML = `
          <table>
            <thead><tr><th>When</th><th>Provider</th><th>Status</th><th class="right">Amount</th></tr></thead>
            <tbody>
              ${rows.map(p=>`
                <tr>
                  <td>${new Date(p.created_at).toLocaleString()}</td>
                  <td>${p.provider}</td>
                  <td><span class="pill">${p.status}</span></td>
                  <td class="right">${fmtUSD(p.amount_cents||0)}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        `;
      }

      function drawLine(canvas, points){
        if (!canvas) return;
        const ctx = canvas.getContext('2d');
        const w = canvas.width = canvas.clientWidth;
        const h = canvas.height = canvas.clientHeight;
        ctx.clearRect(0,0,w,h);
        if (!points.length) return;
        const xs = points.map(p=>p.x), ys = points.map(p=>p.y);
        const minY = 0; const maxY = Math.max(...ys, 1);
        const pad = 24;
        const stepX = (w - pad*2) / Math.max(1, points.length - 1);
        ctx.beginPath();
        points.forEach((p,i)=>{
          const x = pad + i*stepX;
          const y = h - pad - ( (p.y - minY) / (maxY - minY) ) * (h - pad*2);
          if (i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
        });
        ctx.lineWidth = 2; ctx.strokeStyle = '#2563eb'; ctx.stroke();
        // axes
        ctx.strokeStyle = '#e5e7eb'; ctx.lineWidth = 1;
        ctx.beginPath(); ctx.moveTo(pad, h-pad); ctx.lineTo(w-pad, h-pad); ctx.stroke();
      }

      renderSummary(); renderOrders(); renderPayments();
    })();

    // Init
    loadServices();
  </script>
</body>
</html>
